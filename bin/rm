#!/bin/bash
# Security wrapper for rm - SAFE AND NON-INTRUSIVE VERSION

# Function to check if the command is truly dangerous
is_dangerous() {
    local args=("$@")
    local original_user="${SUDO_USER:-$USER}"
    local original_home="/home/$original_user"
    local root_home="/root"

    # Rebuild argument string for simple checks
    local args_str="$*"

    # 1. Recursive deletion of root filesystem
    if [[ "$args_str" == *" -r /"* ]] || [[ "$args_str" == *" -rf /"* ]] || [[ "$args_str" == *" -fr /"* ]]; then
        return 0
    fi

    # 2. Dangerous option --no-preserve-root
    if [[ "$args_str" == *"--no-preserve-root"* ]]; then
        return 0
    fi

    # 3. Check if trying to recursively delete the entire home or /root
    for arg in "${args[@]}"; do
        # Skip options
        [[ "$arg" == -* ]] && continue

        # Expand ~ in the argument
        if [[ "$arg" == ~* ]]; then
            arg="${arg/#\~/$original_home}"
        fi

        # Resolve to absolute path
        resolved=$(realpath -m "$arg" 2>/dev/null || echo "$arg")

        # Dangerous if the target is exactly the home directory, /root, or /
        if [[ "$resolved" == "$original_home" || "$resolved" == "$root_home" || "$resolved" == "/" ]]; then
            # Check if recursive option is present
            for opt in "${args[@]}"; do
                if [[ "$opt" == "-r" || "$opt" == "-rf" || "$opt" == "-fr" ]]; then
                    return 0
                fi
            done
        fi
    done

    # Everything else is allowed
    return 1
}

# If dangerous, block and show message
if is_dangerous "$@"; then
    echo "ï‘§ COMMAND BLOCKED BY SYSTEM SECURITY"
    echo "Command: rm $*"
    if [[ -n "$SUDO_USER" ]]; then
        echo "Executed by: $SUDO_USER (via sudo)"
    fi
    echo "This command has been identified as potentially destructive."
    echo "REASON: Protection against massive deletion of system or home directories"
    exit 1
fi

# Execute real rm if safe
exec /bin/rm "$@"